<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>WES 重构系列（三）：系统融合支持混场业务调度 | Panson</title>

<link rel="shortcut icon" href="https://panson.top/favicon.ico?v=1766826271561">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://panson.top/styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script>
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            Panson
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="/" class="menu gt-a-link">
                            home
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/archives" class="menu gt-a-link">
                            archives
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/sourcecodereading" class="menu gt-a-link">
                            源码阅读与造轮子
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/ai" class="menu gt-a-link">
                            AI
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/supply-chain" class="menu gt-a-link">
                            供应链
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/distributed-job-scheduler-system" class="menu gt-a-link">
                            任务调度
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/photograph" class="menu gt-a-link">
                            摄影
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/about" class="menu gt-a-link">
                            about
                        </a>
                    
                </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1766826271561" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    WES 重构系列（三）：系统融合支持混场业务调度
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2025-01-05 ·
                    </time>
                    
                </div>
                <div class="post-content">
                    <p><em>文内时序图与重构前后对比图需要科学上网才能流畅查看，图床直接用了 GitHub。</em></p>
<figure data-type="image" tabindex="1"><img src="https://images.unsplash.com/photo-1762621362503-c771d36f0d40?q=80&amp;w=2776&amp;auto=format&amp;fit=crop&amp;ixlib=rb-4.1.0&amp;ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="" loading="lazy"></figure>
<h2 id="一-为什么要做货架到人与料箱到人两套系统的融合">一、为什么要做货架到人与料箱到人两套系统的融合？</h2>
<p>随着国内和海外仓业务的发展，部分智能仓要求支持货架到人与料箱到人混场调度，我们旧有的 WES 系统是各自独立的，货架到人 WES 只支持货架仓，料箱到人 WES 只支持料箱仓。</p>
<p>出于支持混场调度，我们做了这次融合。</p>
<h2 id="二-系统融合的规划与难点">二、系统融合的规划与难点</h2>
<p>融合涉及的服务主要是工作站 Station 和 WES。</p>
<p>工作站服务是独立的两套工作流，但业务逻辑有许多共性。比如拣选业务，都要经过实操亮灯、扫码拣选、拍槽位灯、封箱、全部分播完成等步骤，工作流本身支持按业务类型弹实操，这一块相对来说难点不大，主要还是细活，做代码迁移和表迁移，但话说回来，一些细活其实就是工程能力。</p>
<p>WES 这边涉及到的内容多一些：</p>
<ol>
<li>
<p>商品库存：二级库存、三级库存、批次、商品、条码、货主、包装、库存流水、库存调整单、库存快照……</p>
</li>
<li>
<p>理货业务：分为货架到人理货和料箱到人理货，理货单、理货单明细、理货下架作业单、理货下架作业单明细、理货下架任务……</p>
</li>
<li>
<p>盘点：也是多种业务，业务对应的表也很多</p>
</li>
<li>
<p>出库：也是多种业务，业务对应的表也很多</p>
</li>
<li>
<p>上架：离线和在线都有许多业务模式，对应的表也有许多</p>
</li>
</ol>
<p>如果只是实现混场业务调度的目的，粗糙地做也能做，但还是想做一些优化，思考几个问题：</p>
<ol>
<li>
<p>货架到人与料箱到人业务有许多相似点，数据模型（业务表）上有哪些是可以共用的？</p>
</li>
<li>
<p>也有一些不同点，数据模型（业务表）上哪些最好是隔离的？</p>
</li>
<li>
<p>代码层面是否可以使用设计模式抽象一些公有逻辑，减少代码复杂度？</p>
</li>
<li>
<p>合并后，如果海外仓还想继续用单一模式，怎么办？</p>
</li>
</ol>
<h2 id="三-如何取舍数据模型的共用与隔离">三、如何取舍数据模型的共用与隔离？</h2>
<p>两套系统主要还是调度实体不同，我们采用了分层设计原则：上层共用、下层隔离。</p>
<p>在上层的单据层、库存商品层，比如出库单、出库单明细、出库作业单、二级库存，其实都是一致的，两套系统可以共用。</p>
<p>下层的调度任务两者不同，所以我们上层的数据模型不变，下层的调度任务，比如出库任务、理货任务、盘点任务、上架任务都做了分离。</p>
<p>分层图如下：</p>
<figure data-type="image" tabindex="2"><img src="https://github.com/PansonPanson/supply-chain/blob/main/%E4%BE%9B%E5%BA%94%E9%93%BE%E5%AD%90%E7%B3%BB%E7%BB%9F/%E6%99%BA%E8%83%BD%E4%BB%93%E5%82%A8%E7%B3%BB%E7%BB%9F/%E9%87%8D%E6%9E%84%E7%AF%87/assets/WES%20%E9%87%8D%E6%9E%84%E7%B3%BB%E5%88%97%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9A%E7%B3%BB%E7%BB%9F%E8%9E%8D%E5%90%88%E6%94%AF%E6%8C%81%E6%B7%B7%E5%9C%BA%E8%B0%83%E5%BA%A6/file-20251120003840562.png?raw=true" alt="数据模型分层图" loading="lazy"></figure>
<h2 id="四-设计模式与代码复用优化">四、设计模式与代码复用优化</h2>
<h3 id="41-抽出任务基类">4.1 抽出任务基类</h3>
<p>单据调度任务一般包括：</p>
<ul>
<li>
<p>唯一任务 ID</p>
</li>
<li>
<p>状态</p>
</li>
<li>
<p>小车编码</p>
</li>
<li>
<p>小车类型</p>
</li>
<li>
<p>优先级</p>
</li>
<li>
<p>库区</p>
</li>
<li>
<p>状态是否变化</p>
</li>
<li>
<p>……</p>
</li>
</ul>
<p>这些都是料箱业务和货架业务公有的内容，这样定义子类时字段会少许多，保持代码整洁性。</p>
<p>我一直秉承的一个观点是系统的可维护性来源于细节，看似只是抽出了几个基类，但只要处处做到这种复用性，系统会变得清晰许多。</p>
<h3 id="42-实操推送使用工厂方法-模板方法-策略模式">4.2 实操推送使用工厂方法、模板方法、策略模式</h3>
<p>我们的实操任务类型有许多种，包括：</p>
<ul>
<li>
<p>料箱到人在线出库</p>
</li>
<li>
<p>货架到人在线出库</p>
</li>
<li>
<p>料箱到人在线直接上架</p>
</li>
<li>
<p>料箱到人在线空箱上架</p>
</li>
<li>
<p>料箱到人在线空箱出库</p>
</li>
<li>
<p>料箱导入在线推荐上架</p>
</li>
<li>
<p>……</p>
</li>
</ul>
<p>这么多的实操任务，如果写 if else 会很长，那么我们可以用经典的工厂方法 + 模板方法 + 策略模式，来组合实现这个功能。</p>
<p>大致类图：<br>
<img src="https://github.com/PansonPanson/supply-chain/blob/main/%E4%BE%9B%E5%BA%94%E9%93%BE%E5%AD%90%E7%B3%BB%E7%BB%9F/%E6%99%BA%E8%83%BD%E4%BB%93%E5%82%A8%E7%B3%BB%E7%BB%9F/%E9%87%8D%E6%9E%84%E7%AF%87/assets/WES%20%E9%87%8D%E6%9E%84%E7%B3%BB%E5%88%97%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9A%E7%B3%BB%E7%BB%9F%E8%9E%8D%E5%90%88%E6%94%AF%E6%8C%81%E6%B7%B7%E5%9C%BA%E8%B0%83%E5%BA%A6/file-20251120231657887.png?raw=true" alt="" loading="lazy"></p>
<h2 id="五-如何保证业务兼容性">五、如何保证业务兼容性？</h2>
<p>第 3 个要考虑的点是，我们合并之后，万一仓库只想使用单一业务场景，融合后可以支持吗？<br>
当然是可以的。</p>
<h3 id="51-调度层面">5.1 调度层面</h3>
<p>单据调度任务是有库区属性的，单个任务只可能命中单库区，所以在计算任务的时候把库区加上就行了。</p>
<h3 id="52-实操页面">5.2 实操页面</h3>
<p>station 工作流也支持，因为本来就是按调度任务的到站推送来展示的，只要下层的调度任务能区分，工作流实操也能区分。</p>
<h3 id="53-业务模式">5.3 业务模式</h3>
<p>上面两点式库区模式不同，如果是同一个库区，但库区业务模式不同，又该如何支持？<br>
我们可以做配置化，工作站按需配置业务模式。</p>
<h3 id="54-定时任务的精细化管理">5.4 定时任务的精细化管理</h3>
<p>上述第3点 指的是业务模式的入口支持配置化，但对于下层的任务调度定时器，如果现场不启用某些业务模式，是否可以直接关闭对应的定时任务？<br>
答案自然也是可以的，但本期重构没做，后期我们接入了 XXL-JOB，支持定时任务的管理。</p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://panson.top/post/wes-chong-gou-xi-lie-er-ling-yu-hua-fen-zhi-li-huo-ye-wu-shang-fu/" class="post-title gt-a-link">
                    WES 重构系列（二）：领域划分之理货业务上浮
                </a>
            </div>
        

        

        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">清风拂山岗，明月照大江。</div>
    <div class="social-container">
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://panson.top/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
