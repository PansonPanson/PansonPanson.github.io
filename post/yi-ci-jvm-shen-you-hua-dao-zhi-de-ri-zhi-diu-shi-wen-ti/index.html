<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>一次 JVM “神优化” 导致的日志丢失问题 | Panson</title>

<link rel="shortcut icon" href="https://panson.top/favicon.ico?v=1766826271561">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://panson.top/styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script>
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            Panson
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="/" class="menu gt-a-link">
                            home
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/archives" class="menu gt-a-link">
                            archives
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/sourcecodereading" class="menu gt-a-link">
                            源码阅读与造轮子
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/ai" class="menu gt-a-link">
                            AI
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/supply-chain" class="menu gt-a-link">
                            供应链
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/distributed-job-scheduler-system" class="menu gt-a-link">
                            任务调度
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/photograph" class="menu gt-a-link">
                            摄影
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/about" class="menu gt-a-link">
                            about
                        </a>
                    
                </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1766826271561" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    一次 JVM “神优化” 导致的日志丢失问题
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2025-10-30 ·
                    </time>
                    
                </div>
                <div class="post-content">
                    <h2 id="一-问题发生">一、问题发生</h2>
<p>今天同事私聊我，问了我一个问题，他说在一个美国的海外仓项目中发现一个奇怪的报错日志：只有error 日志信息和一个 NPE 日常，但是没有打印出具体的堆栈。</p>
<p>他问我有没有遇到过。</p>
<p>我心里第一个想法：是不是打印日志的地方写得不规范，只把 Exception 的 message 打印了，类似这样：</p>
<!-- more -->
<pre><code class="language-java">log.error(&quot;…… &quot;, exception.getMessage());
</code></pre>
<p>去看了一下代码，发现代码中其实是完整打印的：</p>
<pre><code class="language-java">try {
    // 执行调度逻辑：方法内部调用算法服务，分配库存
} catch (Exception exception) {
     log.error(&quot;……&quot;,  exception);
} finally {
     //
}
</code></pre>
<h2 id="二-求助-ai">二、求助 AI</h2>
<p>面对这个反常的现象，我一开始也向我的好帮手——AI 提问了。</p>
<p>我尝试了各种姿势，并给了一些上下文，去问 AI，得到了一些排查方向：<br>
​1. 确认日志框架​<br>
确认项目使用的是 Logback, Log4j2 还是其他日志框架。<br>
​2. 检查日志级别​<br>
确保记录异常时使用的级别（如 ERROR）在配置中是启用的。<br>
​3. 检查日志配置​<br>
核对配置文件（如 logback.xml, log4j2.xml），看输出目的地（控制台、文件）是否正确。<br>
​4. 验证日志实现​<br>
在 catch块中增加简单输出（如 System.out.println），确认代码执行路径。<br>
……</p>
<p>但似乎没找到我想要的答案。</p>
<h2 id="三-拨云见日十年前的老帖子">三、拨云见日：十年前的“老帖子”</h2>
<p>我决定重新梳理所有上下文，包括业务的调用频率、JVM 的运行环境等等。这个定时器是高频运行的，且每次都会在<strong>同一个地方</strong>报 <strong>NPE</strong>。</p>
<p>我抱着试一试的心态，在 Google/知乎上搜索一些“Java 异常 堆栈 丢失 性能优化”之类的关键词。结果，R 大在 <strong>十年前</strong> 的回答，瞬间击碎了所有的迷雾！</p>
<blockquote>
<p><strong>帖子地址：</strong> <a href="https://www.zhihu.com/question/21405047/answer/45055055">重载 Throwable.fillInStackTrace() 方法以提高Java性能这样的做法对吗？ - RednaxelaFX的回答 - 知乎</a></p>
</blockquote>
<p>R 大的回答里提到了一个 <strong>HotSpot VM</strong> 的“神优化”——<strong>fast throw</strong>！</p>
<blockquote>
<p>HotSpot VM 有个许多人觉得“匪夷所思”的优化，叫做 <strong>fast throw</strong>：有些特定的隐式异常类型（<code>NullPointerException</code>、<code>ArithmeticException</code>（ <code>/ 0</code>）之类）如果在代码里某个特定位置被抛出过多次的话，HotSpot Server Compiler（C2）会透明地决定用 <strong>fast throw</strong> 来优化这个抛出异常的地方——直接抛出一个事先分配好的、类型匹配的异常对象。这个对象的 <code>message</code> 和 <strong>stack trace 都被清空</strong>。</p>
</blockquote>
<p><strong>划重点：</strong> <strong><code>message</code> 和 <code>stack trace 都被清空</code>！</strong></p>
<p><strong>简直是醍醐灌顶！</strong></p>
<p>这种优化的目的是：<strong>抛出这个异常的速度是非常快，不但不用额外分配内存，而且也不用爬栈；</strong> 但缺点就是：<strong>可能正好是需要知道哪里出问题的时候看不到 stack trace 了。</strong></p>
<p>这不就是我的问题吗？！！</p>
<p>顺着这个思路，看了一下这个定时器最早的一次报错，果然是带完整的堆栈信息的。<br>
结合我们的代码，至此可以破案了：获取库位信息并遍历的代码，它被 <strong>高频</strong> 调用，而且由于数据问题，它一直在报 <code>NPE</code>。</p>
<p>JVM 的 C2 编译器一看：“呦，指这行代码天天抛一样的异常，怪累的，我帮他优化一下吧！” 于是，它启动了 <strong>fast throw</strong> 机制，直接抛出预先分配好的、没有堆栈的 <code>NPE</code> 对象，大大提升了抛出异常的速度，但同时也“贴心”地清空了我的日志堆栈！</p>
<h2 id="四-反思">四、反思</h2>
<p>这事儿说到底，是因为我们代码里的 <strong>NPE Bug</strong> 成了 JVM 优化的“燃料”。</p>
<p>当然，知道原因后，我们首先要做的肯定是修复那个导致 NPE 的 Bug。</p>
<p>但从 JVM 层面，如果你确实需要知道高频异常的堆栈，你可以通过一个 VM 参数来<strong>禁用</strong>这个优化：</p>
<pre><code class="language-bash">-XX:-OmitStackTraceInFastThrow
</code></pre>
<p>不过，这个参数的意义是“以性能为代价，换取更完整的堆栈信息”，所以，<strong>更正确的姿势，永远是写出健壮的代码，避免高频抛出隐式异常！</strong></p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://panson.top/post/wes-chong-gou-xi-lie-shi-yi-chu-ku-lian-lu-zhong-de-fen-bu-shi-shi-wu-saga-shi-jian/" class="post-title gt-a-link">
                    WES 重构系列（十一）：出库链路中的分布式事务 Saga 实践
                </a>
            </div>
        

        

        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">清风拂山岗，明月照大江。</div>
    <div class="social-container">
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://panson.top/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
